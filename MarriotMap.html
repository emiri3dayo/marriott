<html>
<head>
  <title>Where have I stayed at Marriott?</title>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css"><script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="http://d3js.org/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>


  <style>svg { border: solid #ccc 1px; }
  path.country { fill: #ccc; stroke: "black";; }
  .d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 1px;
  }

  div.tooltip {
  position: absolute;
  text-align: center;
  width: 80px;
  height: 60px;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}
  </style>
</head>

<body>
  <p>

  <svg id="svg1" height="400" width="1000"></svg>

  <script>
  var svg1 = d3.select("#svg1");

    var projection = d3.geoEquirectangular();
    var pathGenerator = d3.geoPath().projection(projection);

    var rawMap;
    var countries;



    d3.json("world-50m.json", function (error, data) {
      rawMap = data;

      countries = topojson.feature(rawMap, rawMap.objects.countries); //
      showMap();
      var interestingPoints =[[-77.6198,43],[-89,42],[139,35]];
      var places=["Rochester, NY", "Verona Wisconsin", "Tsukiji Tokyo"];
      var linePoints=[10,50,10]


      var circles=svg1.selectAll("circle").data(interestingPoints);
      circles.enter().append("circle").attr("r",1).style("fill","red")
      .merge(circles)
      .attr("cx", function(d) {return projection(d)[0]; })
      .attr("cy", function(d) {return projection(d)[1]; })



      var count=0
      places.forEach(function(d){
        svg1.append("text")
        .text(places[count])
        .style("fill", "blue")
        .style("font-size","10pt")
        .attr("x", function(d) {return projection(interestingPoints[count])[0]+30;})
        .attr("y", function(d) {return projection(interestingPoints[count])[1]+linePoints[count];});
        svg1.append("line")
        .style("stroke", "blue")
        .style("stroke-width",2)
        .attr("x1", function(d) {return projection(interestingPoints[count])[0];})
        .attr("y1", function(d) {return projection(interestingPoints[count])[1];})
        .attr("x2",function(d) {return projection(interestingPoints[count])[0]+30;})
        .attr("y2",function(d) {return projection(interestingPoints[count])[1]+linePoints[count];})
        count=count+1;
      });

    });



    function showMap() {
      projection.fitExtent([[0,0], [svg1.attr("width"), svg1.attr("height")]], countries);
      pathGenerator = d3.geoPath().projection(projection);


      var paths=svg1.selectAll("path.country").data(countries.features);
      paths.enter().append("path").attr("class","country").style("fill","#ccc").style("stroke","#888")
      .merge(paths)
      .attr("d", function(country){
        return pathGenerator(country)

      });
    };

      </script>
</p>
  <p id="p2">
    <svg id="svg2" height="600" width="1000"></svg>
    <script>



      var svg2 = d3.select("#svg2");
      var states;
      var marriottStays;
      var marriottCount=[];

      var projection2 = d3.geoAlbersUsa().scale(75).translate([500/2, 300/2]);
      var pathGenerator2= d3.geoPath().projection(projection2);



      var color = ["#00535F", "#046CB0", "#68C500", "#6BACE4", "#000000",  "#A6002F", "#6D1547"];
      var colorScale = d3.scaleOrdinal().domain(["AC Hotel", "Atlantis", "Courtyard", "Fairfield Inn", "JW Marriott", "Marriott", "Residence Inn"]).range(color);

      d3.queue()
      .defer(d3.json,"us.json")
      .defer(d3.csv,"marriottStays.csv?_=6")
      .await(function (error, usMap, marriottStays) {


        states = topojson.feature(usMap, usMap.objects.states); //only show the states

        marriottUS=marriottStays.filter(function(d) {return d.Country=="USA";});



        for (var index in marriottUS){ //counts total number of marriott stays
          if (marriottUS.hasOwnProperty(index)){
            if (!(marriottUS[index].hotelName in marriottCount)){
              var temparray=[]
              temparray["State"]=marriottUS[index].State
              temparray["count"]=1

              temparray["Latitude"]=marriottUS[index].Latitude
              temparray["Longitude"]=marriottUS[index].Longitude
              temparray["typeOfHotel"]=marriottUS[index].typeOfHotel
              marriottCount[marriottUS[index].hotelName]=temparray
            }
            else {

              marriottCount[marriottUS[index].hotelName]["count"]+=1

            };

        }
      }


    //
    //   for (var i = 0; i < marriottStays.State; i++) {
    //
    // 	// Grab State Name
    // 	var marriottState = marriottStays[i].state;
    //
    //
    // 	// Find the corresponding state inside the GeoJSON
    // 	for (var j = 0; j < json.features.length; j++)  {
    // 		var jsonState = json.features[j].properties.name;
    // 		if (marriottState == jsonState) {
    //
    // 		// Copy the data value into the JSON
    // 		json.features[j].properties.visited = dataValue;
    //
    // 		// Stop looking through the JSON
    // 		break;
    // 		}
    // 	}
    // }




        showMap2();

      });


      function showMap2() {

        projection2.fitExtent([[0,0], [svg2.attr("width"), svg2.attr("height")]], states); //generates the states
        pathGenerator = d3.geoPath().projection(projection2);


        var paths=svg2.selectAll("path.country").data(states.features);
        paths.enter().append("path")
        .attr("class","country")
        .style("stroke","#A4E2A4")
        .merge(paths)
        .style("fill", "#DDE6DD")
        //
        // 	// Get data value
        // 	var value = d.properties.visited;
        //
        // 	if (value) {
        // 	//If value exists…
        // 	return "#00000";
        // 	} else {
        // 	//If value is undefined…
        // 	return "rgb(213,222,217)"
        // };
        //
        // })


        .attr("d", function(country){
          return pathGenerator2(country)
        });





        //modified code from Dave Gotz's using d3-tip with D3.js Version 4 http://bl.ocks.org/davegotz/bd54b56723c154d25eedde6504d30ad7
        //

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");;

        console.log(marriottCount)

        var countScale = d3.scaleSqrt()

        for (var key in marriottCount){

          if (marriottCount.hasOwnProperty(key)){
            d=marriottCount[key]
            svg2.append("circle")
              .attr("cx", projection2([d.Latitude, d.Longitude])[0] )
              .attr("cy", projection2([d.Latitude, d.Longitude])[1] )
              .attr("id", key)
              .attr("r",5)
              .attr("fill-opacity","0.25")
              .attr("stroke", colorScale(d.typeOfHotel))
              .attr("stroke-width",1)
              .attr("fill", colorScale(d.typeOfHotel))
              .attr("r", function() {return (countScale(d.count)*2); })
              .on("mousemove", function(){
                tooltip
                .html(d.count)
                .style("left", d3.event.pageX - 50 + "px")
                .style("top", d3.event.pageY - 70 + "px")
                .style("display", "inline-block");
                      })
              .on("mouseout", function(){ tooltip.style("display", "none");})
              .attr("fill-opacity","0.25");

            };
      }






    };




    </script>
  </p>
</body>
</html>
